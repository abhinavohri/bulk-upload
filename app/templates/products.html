{% extends "base.html" %}

{% block title %}Products - Product Importer{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Product Management</h2>
        <div style="font-size: 1.2rem; font-weight: bold; color: #666;">
            Total Products: <span id="totalCount">0</span>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
        <div>
            <button class="btn" onclick="showCreateModal()">Add Product</button>
            <button class="btn btn-danger" onclick="bulkDelete()">Delete All Products</button>
        </div>
        <div>
            <input type="text" id="searchInput" placeholder="Search by SKU, name, or status (active/inactive)..." style="width: 400px;">
        </div>
    </div>

    <div id="productsTable">
        <div class="loading"></div>
        <p>Loading products...</p>
    </div>

    <div id="pagination" style="margin-top: 1rem; text-align: center;"></div>
</div>

<!-- Modal for Create/Edit Product (Simplified) -->
<div id="productModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; margin: 50px auto; max-width: 600px; background: white; padding: 2rem; border-radius: 8px;">
        <h3 id="modalTitle">Add Product</h3>
        <form id="productForm">
            <input type="hidden" id="productId">
            <div class="form-group">
                <label for="sku">SKU</label>
                <input type="text" id="sku" required>
            </div>
            <div class="form-group">
                <label for="name">Name</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description"></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="active"> Active
                </label>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn">Save</button>
                <button type="button" class="btn" onclick="hideProductModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let searchTimeout;

    // Load products on page load
    loadProducts();

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1;
            loadProducts();
        }, 500);
    });

    async function loadProducts() {
        const search = document.getElementById('searchInput').value;
        const response = await fetch(`/api/products?page=${currentPage}&per_page=20&search=${search}`);
        const data = await response.json();

        // Update total count
        document.getElementById('totalCount').textContent = data.total || 0;

        displayProducts(data);
        displayPagination(data);
    }

    function displayProducts(data) {
        const container = document.getElementById('productsTable');

        if (data.products.length === 0) {
            container.innerHTML = '<p>No products found.</p>';
            return;
        }

        let html = '<table><thead><tr><th>SKU</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead><tbody>';

        data.products.forEach(product => {
            html += `
                <tr>
                    <td>${product.sku}</td>
                    <td>${product.name}</td>
                    <td><span style="color: ${product.active ? 'green' : 'red'};">${product.active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn" onclick="editProduct(${product.id})" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Edit</button>
                        <button class="btn btn-danger" onclick="deleteProduct(${product.id})" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Delete</button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function displayPagination(data) {
        const container = document.getElementById('pagination');
        let html = '';

        if (data.pages > 1) {
            if (data.page > 1) {
                html += `<button class="btn" onclick="changePage(${data.page - 1})">Previous</button> `;
            }

            html += `<span style="margin: 0 1rem;">Page ${data.page} of ${data.pages}</span>`;

            if (data.page < data.pages) {
                html += ` <button class="btn" onclick="changePage(${data.page + 1})">Next</button>`;
            }
        }

        container.innerHTML = html;
    }

    function changePage(page) {
        currentPage = page;
        loadProducts();
    }

    function showCreateModal() {
        document.getElementById('modalTitle').textContent = 'Add Product';
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('active').checked = true;
        document.getElementById('productModal').style.display = 'block';
    }

    function hideProductModal() {
        document.getElementById('productModal').style.display = 'none';
    }

    async function editProduct(id) {
        const response = await fetch(`/api/products/${id}`);
        const product = await response.json();

        document.getElementById('modalTitle').textContent = 'Edit Product';
        document.getElementById('productId').value = product.id;
        document.getElementById('sku').value = product.sku;
        document.getElementById('name').value = product.name;
        document.getElementById('description').value = product.description || '';
        document.getElementById('active').checked = product.active;
        document.getElementById('productModal').style.display = 'block';
    }

    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = document.getElementById('productId').value;
        const data = {
            sku: document.getElementById('sku').value,
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            active: document.getElementById('active').checked
        };

        const url = id ? `/api/products/${id}` : '/api/products';
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            hideProductModal();
            loadProducts();
        } else {
            const error = await response.json();
            alert(error.error || 'An error occurred');
        }
    });

    async function deleteProduct(id) {
        if (!confirm('Are you sure you want to delete this product?')) {
            return;
        }

        const response = await fetch(`/api/products/${id}`, { method: 'DELETE' });

        if (response.ok) {
            loadProducts();
        } else {
            alert('Failed to delete product');
        }
    }

    async function bulkDelete() {
        if (!confirm('Are you sure you want to delete ALL products? This action cannot be undone.')) {
            return;
        }

        const response = await fetch('/api/products/bulk-delete', { method: 'DELETE' });

        if (response.ok) {
            alert('All products deleted successfully');
            loadProducts();
        } else {
            alert('Failed to delete products');
        }
    }
</script>
{% endblock %}
